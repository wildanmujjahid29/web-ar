<!DOCTYPE html>
<html>
  <head>
    <!-- TensorFlow.js & COCO-SSD -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.18.0/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd@2.2.2/dist/coco-ssd.min.js"></script>
    <title>AR Penanda Barang</title>
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>
  </head>
  <body style="margin: 0; overflow: hidden">
    <div
      style="
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 999;
        background: rgba(255, 255, 255, 0.95);
        padding: 20px;
        border-radius: 15px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        display: flex;
        flex-direction: column;
        gap: 10px;
        align-items: center;
      "
    >
      <div style="position: relative; width: 220px; height: 165px">
        <video
          id="preview-foto"
          autoplay
          playsinline
          style="
            display: none;
            width: 220px;
            height: 165px;
            border-radius: 10px;
            object-fit: cover;
            position: absolute;
            left: 0;
            top: 0;
          "
        ></video>
        <canvas
          id="canvas-bbox"
          width="220"
          height="165"
          style="
            display: none;
            position: absolute;
            left: 0;
            top: 0;
            pointer-events: none;
          "
        ></canvas>
        <canvas
          id="canvas-foto"
          width="220"
          height="165"
          style="display: none; position: absolute; left: 0; top: 0"
        ></canvas>
      </div>
      <button
        id="btn-foto"
        style="
          padding: 12px 30px;
          font-size: 16px;
          background: #007bff;
          color: white;
          border-radius: 10px;
          border: none;
          width: 220px;
        "
      >
        Ambil Foto Barang
      </button>
      <input
        id="input-nama"
        type="text"
        placeholder="Nama Barang"
        style="
          padding: 10px;
          font-size: 16px;
          border-radius: 8px;
          border: 1px solid #ccc;
          width: 220px;
          display: none;
        "
      />
      <button
        id="btn-tanda"
        style="
          padding: 15px 30px;
          font-size: 18px;
          background: red;
          color: white;
          border-radius: 10px;
          border: none;
          width: 220px;
          display: none;
        "
      >
        Simpan Barang di Sini!
      </button>
    </div>

    <a-scene
      embedded
      arjs="sourceType: webcam; debugUIEnabled: false;"
      vr-mode-ui="enabled: false"
    >
      <a-camera gps-camera rotation-reader></a-camera>

      <a-entity id="container-barang"></a-entity>
    </a-scene>

    <script>
      // Logika AR Penanda Barang dengan Foto, Nama, dan Persistence
      const tombolSimpan = document.getElementById("btn-tanda");
      const tombolFoto = document.getElementById("btn-foto");
      const wadahBarang = document.getElementById("container-barang");
      const inputNama = document.getElementById("input-nama");
      const videoPreview = document.getElementById("preview-foto");
      const canvasFoto = document.getElementById("canvas-foto");
      const canvasBbox = document.getElementById("canvas-bbox");
      const ctxBbox = canvasBbox.getContext("2d");

      let fotoData = null;
      let posisiBarang = null;
      let streamKamera = null;
      let modelCoco = null;
      let deteksiAktif = false;
      // Load COCO-SSD model saat halaman siap
      window.addEventListener("DOMContentLoaded", async () => {
        modelCoco = await cocoSsd.load();
        renderSemuaBarang();
      });

      // Fungsi untuk menyimpan barang ke localStorage
      function simpanBarang(barang) {
        let data = JSON.parse(localStorage.getItem("ar-barang") || "[]");
        data.push(barang);
        localStorage.setItem("ar-barang", JSON.stringify(data));
      }

      // Fungsi untuk render semua barang dari localStorage
      function renderSemuaBarang() {
        wadahBarang.innerHTML = "";
        let data = JSON.parse(localStorage.getItem("ar-barang") || "[]");
        data.forEach((barang) => {
          // Buat entity gambar
          const gambar = document.createElement("a-image");
          gambar.setAttribute("src", barang.foto);
          gambar.setAttribute("scale", "2 2 2");
          let gpsAttr = `latitude: ${barang.lat}; longitude: ${barang.lon}`;
          if (barang.alt !== undefined && !isNaN(barang.alt)) {
            gpsAttr += `; altitude: ${barang.alt}`;
          }
          gambar.setAttribute("gps-entity-place", gpsAttr + ";");
          gambar.setAttribute("look-at", "[gps-camera]");

          // Buat entity text nama
          const nama = document.createElement("a-text");
          nama.setAttribute("value", barang.nama);
          nama.setAttribute("align", "center");
          nama.setAttribute("color", "black");
          nama.setAttribute("scale", "5 5 5");
          nama.setAttribute("position", "0 2 0");
          nama.setAttribute("gps-entity-place", gpsAttr + ";");
          nama.setAttribute("look-at", "[gps-camera]");

          wadahBarang.appendChild(gambar);
          wadahBarang.appendChild(nama);
        });
      }

      // Render barang saat halaman dibuka
      window.addEventListener("DOMContentLoaded", renderSemuaBarang);

      // Step 1: Ambil foto barang
      tombolFoto.onclick = async function () {
        // Minta akses kamera
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
          alert("Perangkat tidak mendukung kamera langsung.");
          return;
        }
        try {
          streamKamera = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: "environment" },
          });
          videoPreview.srcObject = streamKamera;
          videoPreview.style.display = "block";
          canvasBbox.style.display = "block";
          deteksiAktif = true;
          tombolFoto.textContent = "Ambil Foto Sekarang";
          // Mulai deteksi objek
          requestAnimationFrame(deteksiLoop);
          tombolFoto.onclick = function () {
            // Capture frame ke canvas
            canvasFoto.getContext("2d").drawImage(videoPreview, 0, 0, 220, 165);
            fotoData = canvasFoto.toDataURL("image/jpeg", 0.92);
            // Stop kamera
            streamKamera.getTracks().forEach((track) => track.stop());
            videoPreview.style.display = "none";
            canvasBbox.style.display = "none";
            canvasFoto.style.display = "block";
            tombolFoto.style.display = "none";
            inputNama.style.display = "block";
            tombolSimpan.style.display = "block";
            deteksiAktif = false;
          };
        } catch (e) {
          alert("Tidak bisa mengakses kamera: " + e.message);
        }
      };

      // Loop deteksi objek dan gambar bounding box
      async function deteksiLoop() {
        if (!deteksiAktif || !modelCoco) return;
        // Deteksi objek di frame video
        const prediksi = await modelCoco.detect(videoPreview);
        ctxBbox.clearRect(0, 0, canvasBbox.width, canvasBbox.height);
        prediksi.forEach((obj) => {
          // Gambar bounding box
          ctxBbox.strokeStyle = "#00FF00";
          ctxBbox.lineWidth = 2;
          ctxBbox.strokeRect(
            obj.bbox[0],
            obj.bbox[1],
            obj.bbox[2],
            obj.bbox[3]
          );
          ctxBbox.font = "12px Arial";
          ctxBbox.fillStyle = "#00FF00";
          ctxBbox.fillText(obj.class, obj.bbox[0] + 2, obj.bbox[1] + 14);
        });
        requestAnimationFrame(deteksiLoop);
      }

      // Step 2: Simpan barang setelah isi nama
      tombolSimpan.onclick = function () {
        const namaBarang = inputNama.value.trim();
        if (!namaBarang) {
          alert("Nama barang wajib diisi!");
          return;
        }
        if (!fotoData) {
          alert("Ambil foto barang dulu!");
          return;
        }
        // Ambil posisi GPS (dengan altitude jika ada)
        navigator.geolocation.getCurrentPosition(
          (position) => {
            const lat = position.coords.latitude;
            const lon = position.coords.longitude;
            const alt = position.coords.altitude;
            const barang = {
              nama: namaBarang,
              foto: fotoData,
              lat: lat,
              lon: lon,
              alt: alt,
            };
            simpanBarang(barang);
            alert("Barang berhasil ditandai di: " + lat + ", " + lon);
            // Reset input
            inputNama.value = "";
            fotoData = null;
            canvasFoto.style.display = "none";
            tombolFoto.style.display = "block";
            tombolFoto.textContent = "Ambil Foto Barang";
            inputNama.style.display = "none";
            tombolSimpan.style.display = "none";
            renderSemuaBarang();
          },
          (err) => {
            alert("Gagal mendapatkan lokasi: " + err.message);
          },
          { enableHighAccuracy: true }
        );
      };
    </script>
  </body>
</html>
